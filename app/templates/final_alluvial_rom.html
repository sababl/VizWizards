{% extends "base.html" %}

{% block title %}Alluvial Chart{% endblock %}

{% block content %}

    <h1 style="text-align:center; font-size:20px;">Alluvial Chart - Life Expectancy (2021)</h1>
    <style>
        .info-box {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            text-align: justify;
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .chart-container {
            width: 100%;
            max-width: 1200px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: auto;
        }
        
        svg {
            width: 100%;
            height: auto;
            max-height: 800px;
        }
        
        text {
            font-size: 14px;
        }
    </style>
    
    <div class="info-box">
        <p>
            This alluvial chart provides a visual representation of life expectancy and healthy life expectancy across different countries.
            The chart illustrates how long people are expected to live (Life Expectancy) and how many of those years they can expect to be
            in good health (Healthy Life Expectancy). The width of the flows represents the number of years, allowing for an intuitive 
            comparison between countries. A significant gap between life expectancy and healthy life expectancy indicates that people 
            may be living longer but not necessarily in good health. This visualization is based on the most recent available data from the year 2021.
        </p>
    </div>
  
    <div class="chart-container">
        <svg></svg>
    </div>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3"></script>

    <script>
        const data = [
            { country: "Lesotho", life_exp: 47.8, healthy_life_exp: 42.2 },
            { country: "Central African Republic", life_exp: 49.6, healthy_life_exp: 43.8 },
            { country: "Eswatini", life_exp: 51.6, healthy_life_exp: 45.8 },
            { country: "Somalia", life_exp: 51.7, healthy_life_exp: 45.4 },
            { country: "Nigeria", life_exp: 54.3, healthy_life_exp: 47.6 },
            { country: "Ethiopia", life_exp: 66.1, healthy_life_exp: 58.3 },
            { country: "India", life_exp: 70.8, healthy_life_exp: 62.5 },
            { country: "Germany", life_exp: 81.3, healthy_life_exp: 72.8 }
        ];

        const nodes = [
            ...data.map(d => ({ name: `${d.country}`, color: "#1f77b4" })), // Countries (blue)
            { name: "Life Expectancy (years)", color: "#ff7f0e" }, // Middle Column (orange)
            { name: "Healthy Life Expectancy (years)", color: "#2ca02c" } // Final Column (green)
        ];

        const links = data.flatMap(d => [
            { source: nodes.findIndex(n => n.name === d.country), target: nodes.findIndex(n => n.name === "Life Expectancy (years)"), value: d.life_exp },
            { source: nodes.findIndex(n => n.name === "Life Expectancy (years)"), target: nodes.findIndex(n => n.name === "Healthy Life Expectancy (years)"), value: d.healthy_life_exp }
        ]);

        const width = 1200, height = 800;
        const svg = d3.select("svg")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "xMidYMid meet");

        const sankey = d3.sankey()
            .nodeWidth(20)
            .nodePadding(20) // Increased spacing
            .size([width, height]);

        const { nodes: graphNodes, links: graphLinks } = sankey({
            nodes: nodes.map(d => Object.assign({}, d)), 
            links: links.map(d => Object.assign({}, d))
        });

        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        // Draw links (flows)
        svg.append("g")
            .selectAll(".link")
            .data(graphLinks)
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.sankeyLinkHorizontal())
            .style("stroke-width", d => Math.max(2, d.width))
            .style("fill", "none")
            .style("stroke", "rgba(150, 150, 150, 0.5)") // Light gray
            .style("opacity", 0.6);

        // Draw nodes (rectangles)
        const node = svg.append("g")
            .selectAll(".node")
            .data(graphNodes)
            .enter().append("g");

        node.append("rect")
            .attr("x", d => d.x0)
            .attr("y", d => d.y0)
            .attr("height", d => d.y1 - d.y0)
            .attr("width", d => d.x1 - d.x0)
            .attr("fill", d => colorScale(d.name));

        // Add text labels
        node.append("text")
            .attr("x", d => d.x1 + 10)
            .attr("y", d => (d.y1 + d.y0) / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "start")
            .text(d => d.name)
            .style("font-size", "14px")
            .style("font-weight", "bold");

    </script>

{% endblock %}
