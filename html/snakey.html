<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <title>Alluvial Chart Visualization</title>
</head>
<body>
    <div id="chart"></div>
    <script>
        // Set the dimensions of the chart
        const margin = {top: 20, right: 20, bottom: 20, left: 20};
        const width = 900 - margin.left - margin.right;
        const height = 600 - margin.top - margin.bottom;

        // Create the SVG element
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        // Load the CSV data
        d3.csv("../data/Alluvial_1996.csv").then(function(data) {
            // Assuming the data has columns: 'Entity', 'Continent', 'Annual CO₂ emissions including land-use change'

            // Convert numerical values to number type
            data.forEach(d => {
                d["Annual CO₂ emissions including land-use change"] = +d["Annual CO₂ emissions including land-use change"];
            });

            // Filter top 5 countries for each continent
            const topCountriesByContinent = d3.group(data, d => d.Continent);
            const filteredData = [];

            topCountriesByContinent.forEach((values, key) => {
                const sortedValues = values.sort((a, b) => b["Annual CO₂ emissions including land-use change"] - a["Annual CO₂ emissions including land-use change"]);
                filteredData.push(...sortedValues.slice(0, 5));
            });

            // Create unique nodes and map them to indices
            const nodeMap = new Map();
            let index = 0;
            filteredData.forEach(d => {
                if (!nodeMap.has(d.Continent)) {
                    nodeMap.set(d.Continent, { name: d.Continent, index: index++ });
                }
                if (!nodeMap.has(d.Entity)) {
                    nodeMap.set(d.Entity, { name: d.Entity, index: index++ });
                }
            });

            const nodes = Array.from(nodeMap.values());

            // Create links for each layer (Continent -> Entity)
            const links = [];
            filteredData.forEach(d => {
                links.push({
                    source: nodeMap.get(d.Continent).index,
                    target: nodeMap.get(d.Entity).index,
                    value: d["Annual CO₂ emissions including land-use change"]
                });
            });

            // Update the Sankey Generator to use the node and link arrays correctly
            const sankey = d3.sankey()
                .nodeWidth(15)
                .nodePadding(10)
                .extent([[1, 1], [width - 1, height - 6]])
                .nodes(nodes)
                .links(links);

            const graph = sankey();

            // Add nodes to the chart
            svg.append("g")
                .selectAll("rect")
                .data(graph.nodes)
                .enter()
                .append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0)
                .attr("width", sankey.nodeWidth())
                .style("fill", d => d3.color("steelblue"))
                .append("title")
                .text(d => `${d.name}\n${d.value}`);

            // Add links to the chart
            svg.append("g")
                .attr("fill", "none")
                .selectAll("path")
                .data(graph.links)
                .enter()
                .append("path")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke-width", d => Math.max(1, d.width))
                .style("stroke", "#888")
                .style("opacity", 0.5)
                .append("title")
                .text(d => `${d.source.name} -> ${d.target.name}\n${d.value}`);
        });
    </script>
</body>
</html>
